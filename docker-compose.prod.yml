services:
  # ----------------------------------------------------------------
  # DATABASE LAYER
  # ----------------------------------------------------------------
  db:
    image: postgres:15-alpine
    restart: always
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=5af9cdcd-d594-4e61-9f35-0d39ae4e7486
      - POSTGRES_DB=stelly
    volumes:
      - postgres_prod_data:/var/lib/postgresql/data
      - ./infra/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - stellynet

  redis:
    image: redis:7-alpine
    restart: always
    volumes:
      - redis_prod_data:/data
    networks:
      - stellynet

  minio:
    image: minio/minio
    restart: always
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=b970d197-3d22-401e-83e5-61cff2fa8471
    volumes:
      - minio_prod_data:/data
    command: server /data --console-address ":9001"
    networks:
      - stellynet
    labels:
      - "traefik.enable=true"
      # 1. S3 API Access (e.g. https://s3.stelly.be)
      - "traefik.http.routers.minio-api.rule=Host(`s3.stelly.be`)"
      - "traefik.http.routers.minio-api.entrypoints=websecure"
      - "traefik.http.routers.minio-api.tls.certresolver=myresolver"
      - "traefik.http.services.minio-api.loadbalancer.server.port=9000"
      # 2. Console Access (e.g. https://minio.stelly.be)
      - "traefik.http.routers.minio-console.rule=Host(`minio.stelly.be`)"
      - "traefik.http.routers.minio-console.entrypoints=websecure"
      - "traefik.http.routers.minio-console.tls.certresolver=myresolver"
      - "traefik.http.services.minio-console.loadbalancer.server.port=9001"

  # ----------------------------------------------------------------
  # APPLICATION LAYER
  # ----------------------------------------------------------------
  api:
    build:
      context: ./apps/api
      dockerfile: Dockerfile
    restart: always
    environment:
      - POSTGRES_SERVER=db
      - POSTGRES_PASSWORD=3545dad7-1581-452b-985d-339dd7d9f2d5
      - POSTGRES_DB=stelly
      - REDIS_HOST=redis
      - S3_ENDPOINT=http://minio:9000
      # IMPORTANT: Updates public URLs to use the Traefik route
      - S3_PUBLIC_ENDPOINT=https://s3.stelly.be 
      - S3_ACCESS_KEY=minioadmin
      - S3_SECRET_KEY=b970d197-3d22-401e-83e5-61cff2fa8471
      - DEMO_DOMAIN=demo.stelly.be
    depends_on:
      - db
      - redis
      - minio
    networks:
      - stellynet
    labels:
      - "traefik.enable=true"
      # Route /api requests on ANY subdomain to this container
      - "traefik.http.routers.api.rule=HostRegexp(`{host:.+}`) && PathPrefix(`/api`)"
      - "traefik.http.routers.api.entrypoints=websecure"
      - "traefik.http.routers.api.tls.certresolver=myresolver"
      - "traefik.http.services.api.loadbalancer.server.port=8000"

  web:
    build:
      context: ./apps/web
      dockerfile: Dockerfile.prod
    restart: always
    networks:
      - stellynet
    labels:
      - "traefik.enable=true"
      # Route root requests on ANY subdomain to this container
      # Priority 1 ensures this is the fallback after /api is matched
      - "traefik.http.routers.web.rule=HostRegexp(`{host:.+}`)"
      - "traefik.http.routers.web.priority=1"
      - "traefik.http.routers.web.entrypoints=websecure"
      - "traefik.http.routers.web.tls.certresolver=myresolver"
      - "traefik.http.services.web.loadbalancer.server.port=80"

volumes:
  postgres_prod_data:
  redis_prod_data:
  minio_prod_data:

networks:
  stellynet:
    driver: bridge